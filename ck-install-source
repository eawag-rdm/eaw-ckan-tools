#!/bin/bash

parent=$1
if [ "$parent" == "" ]; then
    echo "usage: ck-install-source SOURCEDIR"
    exit 2
fi

fs_setup() {
    mkdir -p ~/${parent}/lib   
    mkdir -p ~/${parent}/etc
    sudo rm /usr/lib/ckan
    sudo rm /etc/ckan
    sudo ln -s ~/${parent}/lib /usr/lib/ckan    
    sudo ln -s ~/${parent}/etc /etc/ckan
    mkdir -p /etc/ckan/default
    mkdir -p /usr/lib/ckan/default
    #sudo chown `whoami` /usr/lib/ckan
    sudo chown `whoami` /usr/lib/ckan/default
    #sudo chown `whoami` /etc/ckan
    sudo chown `whoami` /etc/ckan/default
    cp /etc/ckan-development_ini-template /etc/ckan/default/development.ini
}

mk_virtenv() {
    virtualenv --no-site-packages /usr/lib/ckan/default
    source /usr/lib/ckan/default/bin/activate
    pip install pip-tools
    deactivate

}

install_src() {
    #git clone git@github.com:ckan/ckan.git /usr/lib/ckan/default/src/ckan
    source /usr/lib/ckan/default/bin/activate
    pip install -e 'git+https://github.com/ckan/ckan.git#egg=ckan'
    ln -s /usr/lib/ckan/default/src/ckan/who.ini /etc/ckan/default/who.ini
    deactivate
}

py-requirements() {
    source /usr/lib/ckan/default/bin/activate
    pip install -r /usr/lib/ckan/default/src/ckan/requirements.txt
    pip install -r /usr/lib/ckan/default/src/ckan/dev-requirements.txt
    deactivate
}

frontend-tools() {
    source /usr/lib/ckan/default/bin/activate
    cd /usr/lib/ckan/default/src/ckan/
    npm install less@1.7.5 nodewatch
    deactivate
}

git-setup() {
    source /usr/lib/ckan/default/bin/activate
    cd /usr/lib/ckan/default/src/ckan/
    git checkout release-v2.4-latest
    git branch -m master ckan_master
    git remote rename origin upstream
    git remote add origin git@github.com:eawag-rdm/eawag-ckan.git
    git remote add ckan-fork git@github.com:eawag-rdm/ckan.git
    git fetch origin
    git branch master origin/master
    git checkout master
    git config --unset remote.upstream.fetch 
    git config --add remote.upstream.fetch +refs/heads/release-v2.4-latest:refs/remotes/upstream/release-v2.4-latest
    git config --add remote.upstream.fetch +refs/heads/master:refs/remotes/upstream/master
    git config --unset remote.ckan-fork.fetch
    git config --add remote.ckan-fork.fetch +refs/heads/master:refs/remotes/ckan-fork/master
    git config --add remote.ckan-fork.push +refs/heads/ckan_master:refs/heads/master
    git config --add branch.ckan_master.pushremote ckan-fork
    git config --add branch.release-v2.4-latest.pushremote origin
    deactivate

# ckan_setup() {
#     source /usr/lib/ckan/default/bin/activate
#     cd /usr/lib/ckan/default/src/ckan
#     python setup.py develop
#     deactivate
# }

get_eaw-tools() {
    git clone git@github.com:eawag-rdm/eaw-tools.git /usr/lib/ckan/default/src/
}

fs_setup
mk_virtenv
install_src
py-requirements
frontend-tools
git-setup
get_eaw-tools

