#!/bin/bash

parent=$1
if [ "$parent" == "" ]; then
    echo "usage: ck-install-source SOURCEDIR"
    exit 2
fi

fs_setup() {
    mkdir -p ~/${parent}/lib   
    mkdir -p ~/${parent}/etc
    sudo rm /usr/lib/ckan
    sudo rm /etc/ckan
    sudo ln -s ~/${parent}/lib /usr/lib/ckan    
    sudo ln -s ~/${parent}/etc /etc/ckan
    mkdir -p /etc/ckan/default
    mkdir -p /usr/lib/ckan/default
    #sudo chown `whoami` /usr/lib/ckan
    sudo chown `whoami` /usr/lib/ckan/default
    #sudo chown `whoami` /etc/ckan
    sudo chown `whoami` /etc/ckan/default
    cp /etc/ckan-development_ini-template /etc/ckan/default/development.ini
}

mk_virtenv() {
    virtualenv --no-site-packages /usr/lib/ckan/default
    source /usr/lib/ckan/default/bin/activate
    pip install pip-tools
    deactivate

}

install_src() {
    #git clone git@github.com:ckan/ckan.git /usr/lib/ckan/default/src/ckan
    source /usr/lib/ckan/default/bin/activate
    pip install -e 'git+https://github.com/ckan/ckan.git#egg=ckan'
    ln -s /usr/lib/ckan/default/src/ckan/who.ini /etc/ckan/default/who.ini
    deactivate
}

py-requirements() {
    source /usr/lib/ckan/default/bin/activate
    pip install -r /usr/lib/ckan/default/src/ckan/requirements.txt
    pip install -r /usr/lib/ckan/default/src/ckan/dev-requirements.txt
    deactivate
}

frontend-tools() {
    source /usr/lib/ckan/default/bin/activate
    cd /usr/lib/ckan/default/src/ckan/
    npm install less@1.7.5 nodewatch
    deactivate
}

# ckan_setup() {
#     source /usr/lib/ckan/default/bin/activate
#     cd /usr/lib/ckan/default/src/ckan
#     python setup.py develop
#     deactivate
# }

get_eaw-tools() {
    git clone git@github.com:eawag-rdm/eaw-tools.git /usr/lib/ckan/default/src/
}

fs_setup
mk_virtenv
install_src
py-requirements
frontend-tools
get_eaw-tools

